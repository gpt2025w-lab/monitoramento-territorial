const { jsPDF } = window.jspdf;

let terrenos = JSON.parse(localStorage.getItem("terrenos")) || [];

/* ======================
   INICIALIZAÇÃO
====================== */

document.addEventListener("DOMContentLoaded", () => {
    gerarProtocolo();
    definirDataAtual();
    atualizarDashboard();
});

/* ======================
   MENU
====================== */

function mostrarSecao(id) {
    document.querySelectorAll(".secao").forEach(sec => {
        sec.classList.remove("ativa");
    });
    document.getElementById(id).classList.add("ativa");
}

/* ======================
   PROTOCOLO AUTOMÁTICO
====================== */

function gerarProtocolo() {
    let numero = terrenos.length + 1;
    let protocolo = "PMIS-" + new Date().getFullYear() + "-" + String(numero).padStart(4,"0");
    document.getElementById("protocolo").value = protocolo;
}

function definirDataAtual() {
    let hoje = new Date().toISOString().split("T")[0];
    document.getElementById("dataCadastro").value = hoje;
}

/* ======================
   SALVAR CADASTRO
====================== */

document.getElementById("formTerreno").addEventListener("submit", function(e){
    e.preventDefault();

    const terreno = {
        protocolo: protocolo.value,
        data: dataCadastro.value,
        responsavel: responsavel.value,
        cpfCnpj: cpfCnpj.value,
        endereco: endereco.value,
        tipo: tipo.value,
        fiscal: fiscal.value,
        zoneamento: zoneamento.value,
        risco: risco.value,
        situacao: situacao.value,
        observacao: observacao.value
    };

    terrenos.push(terreno);
    localStorage.setItem("terrenos", JSON.stringify(terrenos));

    alert("Cadastro salvo com sucesso!");

    this.reset();
    gerarProtocolo();
    definirDataAtual();
    atualizarDashboard();
});

/* ======================
   DASHBOARD
====================== */

function atualizarDashboard(){
    document.getElementById("dashTerrenos").innerText = terrenos.length;
}

/* ======================
   GERAR PDF OFICIAL
====================== */

function gerarPDF() {

    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("PREFEITURA MUNICIPAL", 20, 20);
    doc.text("Sistema Oficial de Cadastro de Terreno", 20, 30);

    doc.setFontSize(12);

    let y = 50;

    doc.text("Protocolo: " + protocolo.value, 20, y); y+=10;
    doc.text("Data: " + dataCadastro.value, 20, y); y+=10;
    doc.text("Responsável: " + responsavel.value, 20, y); y+=10;
    doc.text("CPF/CNPJ: " + cpfCnpj.value, 20, y); y+=10;
    doc.text("Endereço: " + endereco.value, 20, y); y+=10;
    doc.text("Tipo: " + tipo.value, 20, y); y+=10;
    doc.text("Fiscal: " + fiscal.value, 20, y); y+=10;
    doc.text("Zoneamento: " + zoneamento.value, 20, y); y+=10;
    doc.text("Risco Ambiental: " + risco.value, 20, y); y+=10;
    doc.text("Situação: " + situacao.value, 20, y); y+=10;
    doc.text("Observação: " + observacao.value, 20, y);

    doc.save("Relatorio_" + protocolo.value + ".pdf");
}




